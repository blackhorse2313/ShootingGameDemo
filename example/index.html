<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script></script>
    <script src="../Babylon/babylon.3.1.js"></script>
    <script src="../Babylon/babylon-navigation-mesh.js"></script>
    <!-- <script src="../assets/Babylon.js-master/dist/Oimo.js"></script>  新的物理引擎 -->

    <style>
        html, body {
            overflow: hidden;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }
        #renderCanvas {
            width: 100%;
            height: 100%;
            touch-action: none;
        }
        .view-star{
            position: fixed;
            top:0;
            bottom:0;
            right:0;
            left:0;
            margin:auto;
            width: 30px;
            height: 30px;
            background-image: url("../images/ico_star.png");
            background-size: 100% 100%;
            background-repeat: no-repeat;
        }
        .game-overbg{
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(246, 8, 0, 0.6);
            display: none;
        }
        .game-text{
            position: fixed;
            top:0;
            bottom:0;
            right:0;
            left:0;
            margin:auto;
            width: 600px;
            height: 60px;
            line-height: 60px;
            font-size: 60px;
            text-align: center;
        }
    </style>
    <div class="view-star"></div>
    <div class="game-overbg" id="game_over">
        <div class="game-text">游戏结束！！</div>
    </div>
</head>
<body>
<canvas id="renderCanvas"></canvas>
<script type="text/javascript" src="./main.js"></script>
<script type="text/javascript">
    // 从下面的HTML里获取画布元素
    var canvas = document.querySelector("#renderCanvas");

    // 加载BABYLON 3D引擎
    var engine = new BABYLON.Engine(canvas, true);
    // -------------------------------------------------------------
    // 此处开始定义函数，它在构建完后就被调用
    var createScene = function () {
        // 现在创建一个Babylon场景对象

        delete engine;
        engine = new BABYLON.Engine(canvas, true, {
            deterministicLockstep: true,
            lockstepMaxSteps: 4
        });

        scene = new BABYLON.Scene(engine);



        // 改变场景的背景色为绿色.
        scene.clearColor = new BABYLON.Color3(0.2, 0.2, 0.2);

        mp5 = new BABYLON.Sound("Gunshot", "music/m4a12.wav", scene, null, { playbackRate: 1, volume: 2,loop: false });
        hq = new BABYLON.Sound("Gunshot", "music/hq.wav", scene, null, { playbackRate: 1, volume: 2,loop: false });
        sq = new BABYLON.Sound("Gunshot", "music/sq.ogg", scene, null, { playbackRate: 1, volume: 2,loop: false });
        feng = new BABYLON.Sound("Gunshot", "music/bgmkb.mp3", scene, null, { playbackRate: 1, volume: 2,loop: true,autoplay:true });
        gameoverM = new BABYLON.Sound("Gunshot", "music/gameover.wav", scene, null, { playbackRate: 1, volume: 4 });



        camera = new BABYLON.FreeCamera("FreeCamera", new BABYLON.Vector3(  -76.25859464521288, -0.8086594957437754, -15.547828963632178), scene);
        camera.attachControl(canvas, true);
        camera.keysUp.push(87);
        camera.keysDown.push(83);
        camera.keysLeft.push(65);
        camera.keysRight.push(68);
        camera.inertia=0.2;
        camera.speed=1.6;
        camera.angularSensibility=500;
        scene.gravity = new BABYLON.Vector3(0, -0.3, 0);
        camera.fov=1



        // 开启碰撞
        scene.collisionsEnabled = true;


        camera.checkCollisions = true;

        //重力相机。
       camera.applyGravity = true;

        //摄像机上的椭球属性
        camera.ellipsoid = new BABYLON.Vector3(0.4, 1.2, 0.4);
        camera.maxZ=1000
        camera.minZ=0



      /*  var defaultPipeline = new BABYLON.DefaultRenderingPipeline("default", true, scene, [camera]);
        defaultPipeline.bloomEnabled = true;
        defaultPipeline.fxaaEnabled = true;
        defaultPipeline.bloomWeight = 0.1;
        defaultPipeline.cameraFov = 0.1;*/

        scene.fogMode = BABYLON.Scene.FOGMODE_EXP;
        scene.fogColor = new BABYLON.Color3(0, 0, 0);
        scene.fogDensity = 0.005;


        light1 = new BABYLON.HemisphericLight("Omni", new BABYLON.Vector3(50, 100, 50), scene);
        light1.intensity = 0.7;



        light0 = new BABYLON.PointLight("Omni0", new BABYLON.Vector3(0, 0, 0), scene);
        light0.diffuse = new BABYLON.Color3(1, 0.5, 0);
        light0.specular = new BABYLON.Color3(1, 0.5, 0);
        light0.intensity = 0;
        light0.range=10
        light0.angle = 0;
        light0.exponent =0;
        light0.parent=camera;
        light0.position.z=1.5
    //    console.log(light0)
     /*   light0.position.y=0
        light0.position.z=0*/


        light2 = new BABYLON.SpotLight("spotLight", new BABYLON.Vector3(0, 0, 0), new BABYLON.Vector3(-0.1, 0, 1), Math.PI / 3, 2, scene);

        light2.parent=camera;

        light2.diffuse = new BABYLON.Color3(0, 1, 0);
        light2.specular = new BABYLON.Color3(0, 1, 0);

        light2.position.x=0.3
        light2.position.y=0
        light2.exponent=45
        light2.intensity = 10;
        light2.range=40



        shadowGenerator3 = new BABYLON.ShadowGenerator(512, light2);
        //  shadowGenerator.frustumEdgeFalloff = 10.0;
        shadowGenerator3.bias = 0.00005;
        //shadowGenerator3.blurScale=1



        shadowGenerator2 = new BABYLON.ShadowGenerator(512, light0);
        shadowGenerator2.bias = 0.005;
        //shadowGenerator2.blurScale=1


        //m4a1
        box2 = BABYLON.Mesh.CreateBox("crate", 2, scene);
        box2.material = new BABYLON.StandardMaterial("Mat", scene);
        box2.material.alpha=1;
        box2.position = new BABYLON.Vector3(0, 0, 10);
        box2.rotation = new BABYLON.Vector3(0, Math.PI, 0);
        box2.parent=camera;
        box2.checkCollisions = false;
        box2.isPickable=false

        //手枪
        box3 = BABYLON.Mesh.CreateBox("crate", 2, scene);
        box3.material = new BABYLON.StandardMaterial("Mat", scene);
        box3.material.alpha=0;
        box3.position = new BABYLON.Vector3(5, -61, 4);
        box3.parent=camera;
        box3.checkCollisions = false;
        box3.isPickable=false









        //火焰
        box5 = BABYLON.Mesh.CreateBox("crate", 2, scene);
        box5.material = new BABYLON.StandardMaterial("Mat", scene);
        box5.material.alpha=0;
        box5.position = new BABYLON.Vector3(0.3, -0.2, 3);
        box5.parent=camera;
        box5.checkCollisions = false;
        box5.isPickable=false


        box6 = BABYLON.Mesh.CreateBox("crate", 2, scene);
        box6.material = new BABYLON.StandardMaterial("Mat", scene);
        box6.material.alpha=0;
        box6.position = new BABYLON.Vector3(0, 80, 0);
        box6.scaling= new BABYLON.Vector3(3, 3, 3);
        box6.checkCollisions = false;
        box6.isPickable=false

        scene.removeMesh(box3)
        scene.removeMesh(box2)
        scene.removeMesh(box5)
        scene.removeMesh(box6)


        box7 = BABYLON.Mesh.CreateBox("meinv", 2, scene);
        box7.material = new BABYLON.StandardMaterial("Mat", scene);
      //  box7.material.alpha=0;





        box7.position = new BABYLON.Vector3( -65.32206580220254,  -3.318501880339158, -14.782754909696893);
        box7.scaling= new BABYLON.Vector3(0.3, 0.3,0.3);
        box7.checkCollisions = false;
        box7.isPickable=true


        //首先要做的是定义我们的重力矢量，定义G力。在一个经典的世界，如地球，重力的方向沿Y轴向下（负），但随时改变它！



        //并声明哪些网格可能与我们的相机碰撞：
       // ground.checkCollisions = true;
       // box.checkCollisions = true;

       /* // 创建一个光源，在0,1,0点朝向天空.
        var light = new BABYLON.PointLight("light1", new BABYLON.Vector3(115, 110, 10), scene);

        // 将光源光线置为昏暗
        light.intensity = 1;*/





        qiangState=1;




        var freeHuo=new freeHuoConstructor(box5)


        moveSpeed=1;
        freeState=false
        dd=[]

        var decalMaterial = new BABYLON.StandardMaterial("decalMat", scene);
        decalMaterial.diffuseTexture = new BABYLON.Texture("../images/impact.png", scene);
        decalMaterial.diffuseTexture.hasAlpha = true;
        decalMaterial.zOffset = -2;
        decalMaterial.disableLighting=true;


        scene.onAfterStepObservable.add(function () {

         /*   light.position.z=camera.position.z
            light.position.x=camera.position.x
            light.position.y=camera.position.y+50*/


            box7.lookAt(new BABYLON.Vector3(camera.position.x,box7.position.y,camera.position.z))


            if(freeState==true){
                var pickResult = scene.pick(window.innerWidth/2, window.innerHeight/2);
                if (pickResult.hit) {
                 //   console.log(pickResult.pickedMesh.name)
                   // console.log(pickResult.pickedPoint)
                    if(pickResult.pickedMesh.name=="npc"||pickResult.pickedMesh.name2=="meinv"){
                      //  pickResult.pickedMesh.dieState=true
                     //   pickResult.pickedMesh.checkCollisions = false;
                    //    pickResult.pickedMesh.isPickable=false
                        Xue.Position(pickResult.pickedPoint)
                        Xue.start();
                        setTimeout(function(){
                            Xue.stop();
                        },100)
                    }else{
                            setBoom.Position(pickResult.pickedPoint)
                            setBoom.start();
                            setTimeout(function(){
                                setBoom.stop();
                            },100)
                    }
                }
            }


        })




/*
        qiangMaterial= new BABYLON.StandardMaterial("qiang444",scene)
        qiangMaterial.diffuseTexture=new BABYLON.Texture("../images/qiang666.jpg", scene);
        qiangMaterial.diffuseTexture.uScale=0.5
        qiangMaterial.diffuseTexture.vScale=0.5
        qiangMaterial.diffuseTexture.coordinatesIndex=0
        qiangMaterial.specularPower = 10000;
        qiangMaterial.specularColor= new BABYLON.Color4(0, 0, 0,0)*/







        var navigation = new Navigation();
         BABYLON.SceneLoader.ImportMesh("", "../example/model/kejinavmap2/", "kejinavmap2.babylon", scene, function(newMeshesmap) {



             var navmesh = scene.getMeshByName("Navmesh");


             var zoneNodes = navigation.buildNodes(navmesh);
             navigation.setZoneData('level', zoneNodes);


             var npc_state=[0,0,0]

             function castRay() {
                 var origin = camera.position;

                 var _direction = new BABYLON.Vector3(0, Math.PI * -2, 0);

                 var length = 0.5;

                 var ray = new BABYLON.Ray(origin, _direction, length);
                 // ray.show(scene, new BABYLON.Color3(1, 1, 0.1));

                 var hit = scene.pickWithRay(ray);
                 hit.fastCheck = true;

                 if (hit.pickedMesh) {

                     var path = navigation.findPath(box7.position, hit.pickedPoint, 'level', navigation.getGroup('level', box7.position)) || [];

                     if (path && path.length > 0) {
                         var length = 0;
                         var direction = [{
                             frame: 0,
                             value: box7.position
                         }];
                         for (var i = 0; i < path.length; i++) {
                             length += BABYLON.Vector3.Distance(direction[i].value, path[i]);
                             direction.push({
                                 frame: length * 100,
                                 value: path[i]
                             });
                         }

                         for (var i = 0; i < direction.length; i++) {
                             direction[i].frame /= length;
                         }

                         var moveCamera = new BABYLON.Animation("CameraMove", "position", 180 / length + 10, BABYLON.Animation.ANIMATIONTYPE_VECTOR3, BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT);

                         moveCamera.setKeys(direction);

                         box7.animations.push(moveCamera);


                         //    console.log(getDistance(box7,camera))
                         if (getDistance(box7, camera) <= 10 && getDistance(box7, camera) >= 5) {

                             npc_state[1] = 0
                             if (npc_state[0] == 0) {
                                 npc_state[0] = 1
                                 npc_pao()
                             }
                             scene.beginAnimation(box7, 0, 100, false, 1);

                         } else if (getDistance(box7, camera) >= 11) {
                             npc_state[0] = 0
                             if (npc_state[1] == 0) {
                                 npc_state[1] = 1
                                 npc_pao()
                             }
                             scene.beginAnimation(box7, 0, 100, false, 2);
                             npc_zou()
                         } else if (getDistance(box7, camera) <= 5) {
                             if (npc_state[2] == 0) {
                                 npc_state[2] = 1
                                 gameover()
                                 fps_D.forEach(function (mesh) {
                                     mesh.position.y = 1000
                                 })
                                 gameoverM.play()
                                 setTimeout(function () {
                                     document.getElementById("game_over").style.display = "block";
                                 }, 1000)
                             }
                             scene.beginAnimation(box7, 0, 0, false, 0);
                             camera.detachControl(canvas, false);
                             camera.setTarget(new BABYLON.Vector3(box7.position.x, camera.position.y, box7.position.z))
                         }


                         //npcmove.speedRatio=4
                     }

                 }

             }

             setInterval(function(){
                 castRay();
             },1000)





            newMeshesmap.forEach(function(mesh,index){

                // mesh.checkCollisions = true;
                mesh.isPickable = true;
                mesh.checkCollisions = true;

                 //   mesh.parent=box6
              //   box6.scaling=new BABYLON.Vector3(1,1,1)
                 //      shadowGenerator.getShadowMap().renderList.push(mesh);
                 shadowGenerator2.getShadowMap().renderList.push(mesh);
                 shadowGenerator3.getShadowMap().renderList.push(mesh);
                 mesh.receiveShadows = true;

                 if(mesh.name!="Navmesh"){
                     /* mesh.material=qiangMaterial
                      mesh.clone().material=qiangMaterial*/
                 }else{
                     mesh.visibility=0;
                     mesh.checkCollisions = false;
                     mesh.isPickable = false;
                 }



              /*  mesh.createOrUpdateSubmeshesOctree(1000, 1000)
                mesh.useOctreeForCollisions()*/

             })

             newMeshesmap.forEach(function(mesh,index){
                 mesh.subdivide(100)
                 mesh.createOrUpdateSubmeshesOctree()
                 mesh.useOctreeForCollisions()
                 mesh.useOctreeForPicking()
                 mesh.useOctreeForRenderingSelection()
             })



          //   var octree = scene.createOrUpdateSelectionOctree(200, 2)


    })


        function getDistance(e,o) {
            var n = e.position.x
                , t = e.position.y
                , i = e.position.z
                , r = o.position.x
                , s = o.position.y
                , a = o.position.z;
            return Math.sqrt(Math.pow(n - r, 2) + Math.pow(t - s, 2) + Math.pow(i - a, 2))
        }

        BABYLON.SceneLoader.ImportMesh("", "../example/model/npc_njs2/", "npc_njs2.babylon", scene, function(newMeshesmap, particleSystems,skeletons) {
            newMeshesmap.forEach(function(mesh,index){
                    mesh.name2="meinv"
                    mesh.parent=box7



                var c_music=0;

                var music = new BABYLON.Sound("Violons", "music/nv_npc_jiao.wav", scene, function(){
                    musicPlay()
                }, { volume: 0,loop:true });


                var music2 = new BABYLON.Sound("Violons", "music/nv_npc_jiao2.wav", scene, function(){
                    musicPlay()
                }, { volume: 0,loop:true });

                var clearM=[];

                function musicPlay(){
                    c_music++
                    if(c_music>=3) {
                        music.play()
                        music2.play()
                    }
                        this.m1=function(){
                                music.currentTime = 0;
                                music2.currentTime = 0;
                                music.setVolume(4)
                                music2.setVolume(0)
                        }

                        this.m2=function(){
                            music.currentTime = 0;
                            music2.currentTime = 0;
                                music.setVolume(0)
                                music2.setVolume(4)
                        }
                        this.m3=function(){
                            music.currentTime = 0;
                            music2.currentTime = 0;
                            music.setVolume(0)
                            music2.setVolume(0)
                        }

                }

                var objMusic=new musicPlay()

                music.maxDistance=30;
                music.attachToMesh(box7);

                    mesh.isPickable = true;
                    box7.scaling=new BABYLON.Vector3(0.04,0.04,0.04)
                 //   shadowGenerator.getShadowMap().renderList.push(mesh);
                    shadowGenerator2.getShadowMap().renderList.push(mesh);
                    shadowGenerator3.getShadowMap().renderList.push(mesh);

                mesh.position.y+=23

                npc_zou=function(){
                    scene.beginAnimation(mesh, 162, 226, true);
                    objMusic.m2()
                //    console.log(1111111)
                }

                npc_pao=function(){
                    scene.beginAnimation(mesh, 227, 263, true);
                    objMusic.m1()
                 //   console.log(2222222)
                }

                gameover=function(){
                    scene.beginAnimation(mesh, 264, 325, true);
                    objMusic.m3()
                //    console.log(3333333)
                }




            })
        })



        loadMeshes(models,function(){
            v_1.show()
        })


        document.onkeydown = keyevent;
        document.onkeyup = keyevent2;

        var isLocked = false;


        var v_1_state;
        var v_2_state=true;
        var v_3_state;


        scene.onPointerDown = function (evt) {

            camera._needMoveForGravity = true;


            if(qiangState==1){
                light0.intensity=1;
                freeState=true;
                freeHuo.start()
                mp5.play()
                v_1.do();
                freemusic=setInterval(function(){mp5.stop();lightFree(); v_1.do(); mp5.play()},20)
                // mp5.stop();lightFree(); mp5.play()
            }else if(qiangState==2){
                light0.intensity=1;
                //sq.play()
                if(v_2_state==true){
                    freeState=true;
                    freeHuo.start()
                    v_2.do()
                    sq.stop(); lightFree(); sq.play()
                    v_2_state=false;
                    setTimeout(function(){
                        v_2_state=true;
                    },500)
                }

            }else if(qiangState==3){
                freeState=false;
                //sq.play()
                v_3.do()
              /*  sq.stop();
                sq.play()*/
            }


            function lightFree(){
                light0.intensity=1;
                setTimeout(function(){
                    light0.intensity=0;
                },0)
            }



          /*  free.reset()
            free2.reset()
            free_2.reset()
            free2_2.reset()*/

            //true/false check if we're locked, faster than checking pointerlock on each single click.
            if (!isLocked) {
                canvas.requestPointerLock = canvas.requestPointerLock || canvas.msRequestPointerLock || canvas.mozRequestPointerLock || canvas.webkitRequestPointerLock || false;
                if (canvas.requestPointerLock) {
                    canvas.requestPointerLock();
                }
            }

            // if the click hits the ground object, we change the impact position
            /* if (newMeshes.hit) {
                 console.log(newMeshes.pickedMesh.name)
             }
             if (newMeshes2.hit) {
                 console.log(newMeshes.pickedMesh.name)
             }*/

        };

        scene.onPointerUp = function (evt) {

            light0.intensity=0

            clearInterval(freemusic)
            //  gunshot.stop();

            freeState=false;
            freeHuo.stop()

          /*  free = scene.beginAnimation(scene.getMeshByID("1ea0aafd-8f1a-4d57-bd34-3542b5a7baed"), 75, 75, false,1.5);
            free2 = scene.beginAnimation(scene.getMeshByID("7270915d-8281-4797-a173-3a06ef9a6418"), 75, 75, false,1.5);

            free_2 = scene.beginAnimation(scene.getMeshByID("66b54ec6-cd3b-47ba-96b6-e09c26c35dc9"), 75, 75, false,1);
            free2_2 = scene.beginAnimation(scene.getMeshByID("0c00c3cf-2490-4da7-b8c2-28ba5216ba10"), 75, 75, false,1);*/

        }



    /*    yu1 = BABYLON.Mesh.CreateBox("crate", 2, scene);
        yu1.material = new BABYLON.StandardMaterial("Mat", scene);
        yu1.material.alpha=0;
        yu1.position = new BABYLON.Vector3(0, 280, 0);*/


        var skybox = BABYLON.Mesh.CreateBox("skyBox", 600.0, scene);
        var skyboxMaterial = new BABYLON.StandardMaterial("skyBox", scene);
        skyboxMaterial.backFaceCulling = false;
        skyboxMaterial.reflectionTexture = new BABYLON.CubeTexture("../images/sky15/sky", scene);
        skyboxMaterial.reflectionTexture.coordinatesMode = BABYLON.Texture.SKYBOX_MODE;
        skyboxMaterial.diffuseColor = new BABYLON.Color3(0, 0, 0);
        skyboxMaterial.specularColor = new BABYLON.Color3(0, 0, 0);
        skyboxMaterial.emissiveColor  = new BABYLON.Color3(0, 0, 0);
        skyboxMaterial.disableLighting = true;
        skybox.material = skyboxMaterial;
        skybox.applyFog=false;

    //    var xiayu=new Yu(yu1)
       // xiayu.start()

        var setBoom=new setBooms(new BABYLON.Vector3(-16,0,0))

        var Xue=new Xues(new BABYLON.Vector3(-16,0,0))


        // 离开该函数
        return scene;
    }; // End of createScene function
    // -------------------------------------------------------------
    // 现在, 调用刚创建完的createScene函数
    scene = createScene();
    // 注册一个渲染循环已重复的渲染场景
    engine.runRenderLoop(function () {
        scene.render();
    });
    // 监测浏览器/画布大小改变事件
    window.addEventListener("resize", function() {
        engine.resize();
    });
</script>

</body>
</html>